# Phased Array Aligner

山口 32m-34m 干渉計のデータを相関処理し、フェーズドアーレイ（結合型干渉計）出力を生成するための Rust プログラムです。

## 主な機能
- **高精度ドップラー補正**: 地球自転に伴う幾何学的遅延を 1秒ごとに更新し、フレーム単位で精密に補正します。
- **相関解析 (`--debug-corr`)**: 相互相関関数 (CCF) を計算し、フリンジ（干渉縞）のピーク検出とプロットを行います。
- **フェーズドアーレイ合成**: 2つのアンテナ信号を位相を揃えて加算し、1つの強力な単一アンテナデータのように出力します。
- **LSB/USB 対応**: サンプラーのサイドバンド設定に応じた適切な周波数反転処理を行います。

## ビルド方法
Rust の開発環境（Cargo）が必要です。
```bash
cargo build --release
```

## 使い方

### 基本的な実行例
`.ifile`（設定ファイル）とデータディレクトリを指定して実行します。
```bash
./target/release/phased_array --ifile 3C345.ifile --data raw --fft 1024 --length 60 --debug-corr --sideband ant1:LSB ant2:LSB
```

### 主要なオプション

| オプション | 短縮名 | 説明 |
| :--- | :--- | :--- |
| `--ifile <PATH>` | - | 天体座標やアンテナ位置が記された設定ファイル。 |
| `--data <DIR>` | - | `.raw` データファイルが格納されているディレクトリ。 |
| `--fft <INT>` | - | FFT ポイント数（デフォルト: 16384）。相関探索には 1024 等が推奨。 |
| `--length <SEC>` | `--sec` | 処理するデータの長さ（秒）。 |
| `--debug-corr` | `--dcorr` | 詳細な相関解析（フリンジサーチ）を実行し、プロットを生成。 |
| `--sideband <usb\|lsb>` | - | サンプラーのサイドバンド設定。 |
| `--obsfreq <MHZ>` | - | 観測帯域の下限周波数（MHz）。ドップラー補正の基準として使用。 |
| `--sampling <MHZ>` | `--fs` | サンプリング周波数（MHz、デフォルト: 1024.0）。 |
| `--cpu <INT>` | - | 使用する CPU コア数。 |
| `--delay <FLOAT>` | - | アンテナ2に適用する残留遅延（サンプル単位）。 |
| `--rate <FLOAT>` | - | アンテナ2に適用する残留レート（Hz）。 |

## 出力ファイル

実行後、`phased_array/YAMAGU66_yyyydddhhmmss/` ディレクトリに以下のファイルが生成されます。

1.  **`.raw` ファイル**: フェーズドアーレイ合成後の生データ。
2.  **`.cor` ファイル**: `frinZ` 等で解析可能な相関スペクトルデータ。
    - `..._phasedarray.cor`: アンテナ間のクロススペクトル。
    - `..._ant11.cor` / `..._ant22.cor`: 各アンテナの自己相関スペクトル。
3.  **`..._geometricdelay.txt`**: 1秒ごとの幾何学的遅延の計算ログ。
4.  **`.png` プロット**: CCF の強度、位相、スペクトル形状などを視覚化した画像。

## 幾何学的モデルの精度について
本プログラムは、IAU 2006 モデルに基づく GMST 計算と数値微分を用いて、地球自転による遅延変化を追従します。現在、標準的な ITRF/ECEF 座標系（Y軸が東経90度）に準拠しており、山口基線において高い精度でフリンジを停止させることが可能です。
